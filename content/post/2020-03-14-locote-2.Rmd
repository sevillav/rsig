---
title: "Trabajando con layers Shapefile y Raster de SIG en R"
author: "Victor Sevilla"
date: '2020-03-14'
output:
  html_document:
    df_print: paged
slug: locote-2
tags: []
categories: []
---

### Por: CampoAmbiente.com

Nuestro objetivo es mostrar una manera de trabajar layers SIG del tipo Shapefile (Vectoriales) y Tiff (Raster) en R para realizar analisis estadisticos que sean utiles en estudios agroambientales.

Trataremos diferentes aspectos como:

* Importar layers Shapefile y Raster de Sistemas de Informacion Geografica (SIG) a R.
* Crear graficos con ellas (plotearlos).
* Conocer su proyeccion cartografica.
* Reproyectarlas.
* ....

Emplearemos las aplicaciones R y RStudio y, datos espaciales o layers como: Partes de aguas, Modelos digital de elevación y una capa de muestreo de suelos con datos atributivos de los mismos. Todos pertenceintes a la cuenca hidrográfica del río Canoabo en Venezuela.

**Descargo:** Por supuesto que existe una gran cantidad de formas y maneras de trabajar layers de SIG en R. Esta es solo una de esas formas, la que nosotros empleamos. Si conocen otra manera de hacerlo diferente a la mostrada, para nosotros seria un gusto y un valioso aporte recibir sus ideas y opiniones. Con esto en conjunto podriamor incremetar nuestro aporte a la comunidad de R-SIG.

###Iniciamos procedimientos:

1. Estableceremos nuestro directorio de trabajo, donde ubicaremos toda nuestra informacion y crearemos los objetos nuevos:
```{r, eval=FALSE}
setwd("C:/Sevilla/rsig/content/post")
```
2. Verificamos que efectivamente nos ubicamos en el directorio de trabajo deseado:
```{r}
getwd()
```
3. Activamos las librerias o paquetes necesarios que contienen las funciones a `emplear`:
```{r}
library(raster)
```
> Si desea conocer mas de las funciones del paquete Raster puede
dirigirse a la pagina CRAN-R en la seccion de paquetes, aqui les dejamos un enlace directo. [Raster](https://cran.r-project.org/web/packages/raster/index.html)

4. Importamos los Layers Shapefile y Raster originados en SIG y creamos objetos R:

**Layers Shapefile:**
```{r}
perimetro <- shapefile("C:/Sevilla/Canoabo1/cuenca1.shp")
```
Como observo creamos un objeto R llamado **perimetro** empleando la funcion `shapefile` e indicamos en que directoria se encuentra el layers Shapefile. Si realizaste el paso previo de establecer el directorio de trabajo (`setwd`), entonces bastaria solo colocar el nombre del layers Shapefile con su extension shp, en nuestro caso seria _cuenca1.shp_.

**Layers Raster** 
```{r}
DEM <- raster("C:/Sevilla/Canoabo1/MDE3.tif")
```
Como observo creamos un objeto R llamdo **DEM** mediante la funcion `raster` e indicamos en que directoria se encuentra el layers Raster (tif). Si realizaste el paso previo de establecer el directorio de trabajo (`setwd`), entonces bastaria solo colocar el nombre del layers Raster con su extension tif, en nuestro caso seria _MDE3.tif_.vemos

5.- Observemos nuestros objetos R recien creado en el directorio o en la memoria de R con la funcion `ls`:
```{r}
ls()
```
6. Grafiquemos nuestros objetos R recien creados (Modelo digital de elevacion - DEM y el perimetro)
```{r}
plot(DEM, main="Modelo Digital de Elevacion (msnm)")
lines(perimetro, col="blue")
```
Como se ve en la Figura anterior, la funcion `plot` nos permite graficar el objeto R que representa el modelo digital de elevacion **(DEM)**, mostrando las alturas del terreno con respecto al nivel medio del mar. Ademas adicionamos el objeto R llamado **Perimetro**, que no es mas que el limite de la cuenca.

7. Observemos las estadicticas basicas del Modelo digital de elevacion:
```{r}
summary(DEM, maxsamp = ncell(DEM))
#Para calcular las estadíticas sobre todo el raster y no sobre una muetra
#aleatoria se empleo la opcion getOption = maxsamp.

# BUSCAR COMO PONERLO EN UNA TABLA.
```

8. Busquemos conocer la proyeccion cartografica de nuestros dos layers (CRS = "Sistema de referencia de coordenadas"):
```{r}
#Primero la del objeto R shape (Perimetro):
crs(perimetro)
```
```{r}
#Segundo la del objeto raster (DEM)
crs(DEM)
```
Observemos que ambos objetos R poseen: Proyeccion UTM Huso 19 Norte, unidad metros, elipsoide internacional 1924.

9. Si deseamos cambiar de proyeccion (reproyectar) se procede como a continuacion se describe un ejemplo para cada tipo de objeto R creados (shape o raster).
Vamos a reproyecatarlas al sistema de coordenadas geograficas con el datum WGS84:
```{r}
#En el caso de desear reproyectar un objeto R vectorial shape puede hacerlo de la siguiente forma
#aqui cambiamos solo del datum de "La Canoa" a "WGS 84":
perimetro_gw <- spTransform(perimetro, CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"))

library(mapview)
mapView(perimetro_gw)

# una manera de estar seguro de la similitud en extension de dos capas. especificamente en
# el estudio de Cuencas, es cortar la capa raster con la capa vectorial (perimtetro), como 
# se muestra a continaucion:
DEM1 = crop(DEM, perimetro)
DEM2 = mask(DEM1, perimetro)

# y aqui continuamos con un ejemplo de como reproyectar una capa del tipo raster, en este caso, solo cambiamos del datum "La Canoa" a "WGS 84":
DEM2_gw = projectRaster(DEM, crs = "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0", method='bilinear')
```

Ahora vamos a crear un objeto R a partir de una capa shape que contiene la informacion de perfiles de suelos.
```{r}
# Creamos el objeto R vectorial (shape) de perfiles de suelos:
suelos <- shapefile("C:/Sevilla/Canoabo1/suelos8.shp")

# Vemos las principales carataeristicas del obejto recioen creado:
suelos

# Le asignamos la proyeccion cartografica correspondiente, ya  que no la tenia en la capa original, pero nosotros la conocemos:
suelos@proj4string <- crs("+proj=utm +zone=19 +ellps=intl +units=m +no_defs")
```
Ploteamos los tres objetos R creados en un solo graficos:
```{r}
plot(DEM)
lines(perimetro, lwd=2)
points(suelos, col="blue", pch=19)
legend("topleft", "pH > 5.5", pch=19, col = "blue")
legend("topleft", "pH < 5.5", pch=19, col = "red")
text(labels(suelos@data$ID))
#labels <- rownames(suelos)

```
Continuamos revisando algunas caraterisicas del objeto R de perfiles de suelos:
```{r}
# Observamos los 6 primeros registro de su base de datos:
head(suelos, 5)

# Observamos los 6 ultimos registro de su base de datos:
tail(suelos,5)

# Vemos el numero de filas y columnas:
dim(suelos)

# Observamos la clase del objeto R suelos:
class(suelos)

# Vemos el espacio que ocupa en memoria el objeto R suelos (Bytes):
object.size(suelos)

# Vemos los nombres de sus columnas, campos o variables:
names(suelos)

# Observamos un resumen de las es

# extraeremos un subgrupo del objeto R origina de suelos, que cumplan un criterio, el cual es que su pH sea menor y mayor a 5.5 pH.
suelos_ma <- subset(suelos, H1_PH > 5.5, c(3,4,5,52))
suelos_ma

suelos_me <- subset(suelos, H1_PH <= 5.5, c(3,4,5,52))
suelos_me

plot(DEM, main="Perfiles de suelos")
points(suelos_ma, pch=19, col="blue", cex=1.2)
points(suelos_me, pch=19, col="red", cex=1.2)

plot(suelos$H1_PH, pch=19, col="blue", type="b")
legend(2,8, "pH", pch = 19, col = "blue")
abline(h=5.5)
#box(lty = '1373', col = 'red')



suelosph <- suelos@data[suelos$H1_PH > 0, c("NOMBRE", "H1_PH")]

plot(suelosph$H1_PH, pch=19, col="blue", type="b")

plot(suelos$H1_PH)
legend(2, 7, "alirio", pch=17)

which(is.na(suelos$H1_PH))


summary(suelosph$H1_PH)
summary(suelos$H1_PH)
```

```{r}
plot(suelosph$H1_PH, pch=19, col="blue", type="b")
text(10, 20, "aqui no")
```

Pendientes:

hacer un resumen de una característica como pH.

hacemos un mapas con los sitios de suelos con mayor y menor a 5.5 de pH.

Cambiamos el nombre del campo "Tree" por "arboles":
datos1 <- rename(Orange, arboles = Tree)
